$ = require 'jquery'
_ = require 'lodash'
Backbone = require 'backbone'
Utils = require 'utils'

#文件视图
exports.FileItemView = Backbone.View.extend
	tagName:'div'
	initialize:( options )->
		#初始化逻辑
		this.listenTo this.model, 'destroy', this.remove

	events:
		'click .img':'showBigImg'
		'click .delFile':'delFile'
		'click .downloadFile':'downloadFile'
		
	#渲染文件视图
	render:()->
		self = this
		reg = /.*\.((jpeg)|(jpg)|(png)|(gif))/g #如果是图片才能点击查看大图
		rlt = reg.exec( self.model.get 'fileName' )
		isImage = rlt? and rlt.length
		src = if isImage then Utils.getUrlByAttach( self.model ) else 'displayfile/file.png'
		dom = """
				<img class="#{if isImage then 'img' else ''}" src="/#{src}"></img>
				<div class="fun-container">
					<span class="fileName">#{self.model.get 'fileName'}</span>
					<input type="button" class="delFile" style="" value="删除"/>
					<input type="button" class="downloadFile" value="下载"/>
				</div>
			"""
		self.$el.html( dom ).addClass( 'file-item-container' )
		return self
		
	
	#查看大图
	showBigImg:( event )->
		self = this
		$target = $( ( event || window.event ).target )
		src = $target.attr( "src" )
		$( '#bigImg' ).attr( "src", src )
		$( '#big-img-container' ).show()
		layer.open
			type:1
			title :'查看大图'
			content:$('#big-img-container')
			area:['490px','650px']

	#删除该条数据
	delFile:()->
		this.model.destroy( {url:'applyController.do?deleteJpeg&id='+this.model.get('id')} )

	downloadFile:()->
		window.open( 'applyController.do?downloadById&id=' + this.model.get( 'id' ) )
			