# $ = require 'jquery'
# _ = require 'lodash'
# Backbone = require 'backbone'
FileItemView = ( require 'views/FileItemView' ).FileItemView
FileItemModel = ( require 'models/FileItemModel' ).FileItemModel
FileItemCollection = ( require 'collections/FileItemCollection' ).FileItemCollection

Service = require 'Service'

#文件视图
exports.AppView = Backbone.View.extend
	initialize:( options )->
		$( '#big-img-container' ).hide()
		if readOnly? and readOnly
			$( '.add-file' ).hide()
		self = this
		files = new FileItemCollection()
		self.files = files
		files.comparator = 'SEQ'
		self.listenTo files, "add", this.addOne
		self.listenTo files, 'reset', this.addAll
		window.fileChangeCallback = ()->
			self.fileChangeCallback()
		Service.getFilesById.apply self
			.done ( data )->
				if data.success
					files.reset data.obj
				else
					layer.alert '根据单号请求附件列表失败！'
			.fail ()->
				layer.alert '根据单号请求附件列表失败！'

	events:
		'click .add-file':'addFile'
		# 'change #hid-input-file':'fileChangeCallback'
		
	#选择文件
	addFile:()->
		#选择文件，选择完成上传到服务器
		$('#hid-input-file').click()

	#选完之后直接上传
	fileChangeCallback:()->
		self = this
		f = $('#hid-input-file')[0].files[0]
		fileName = f.name

		_handler = ( event )->
			console.log( event )
			status = event.target.status;
			responseText = event.target.responseText;
			if status >= 200 && status < 300
				console.log( responseText )
				data = eval( '(' + responseText + ')' )
				if data.ok
					$.ajax
						url:'applyController.do?upLoadJpeg',
						method:'GET',
						dataType:'json',
						data: { path:data.data,fileName:fileName,applyId:window.applyId,type:window.type }
					.done ( data )->
						if data.success
							layer.msg( '上传成功！', {icon: 1, time: 2000 } )
							modTmp = new FileItemModel( data.obj )
							self.files.push modTmp
						else
							layer.msg( '上传成功，插入附件表失败！', {icon: 2, time: 2000 } )
					.fail ()->
						layer.msg( '上传失败！', {icon: 2, time: 2000 } )
					.always ()->
						layer.close idx
			else
				layer.msg( """上传失败！""", {icon: 1, time: 2000 } )
				layer.close idx

		idx = layer.load '上传中'
		xhr = new XMLHttpRequest()
		xhr.open( 'POST', 'http://' + document.domain + ':' + location.port + "/uploadImg" )
		xhr.timeout = 60000
		xhr.onload = _handler
		xhr.onerror = _handler
		xhr.onabort = _handler
		xhr.send( f )

	#添加一个文件
	addOne:( d )->
		itemView = new FileItemView( {model:d} )
		this.$el.find( '.add-file' )
			.before( itemView.render().$el )

	addAll: ()->
		this.files.each this.addOne, this